<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>网页拨号盘</title>
<style>
  :root{
    --btn-size:60px;             /* 拨号键尺寸 */
  }
  body{
    font-family:Arial, sans-serif;
    background:#f0f0f0;
    margin:0;
    display:flex;
    flex-direction:column;
    align-items:center;
  }
  /* ① 顶端输入框 */
  #topArea{
    width:100%;
    max-width:320px;
    display:flex;
    flex-direction:column;
    align-items:center;
    margin-top:12px;
  }
  #numberDisplay{
    font-size:24px;
    width:100%;
    text-align:center;
    padding:10px;
    background:#fff;
    border-radius:8px;
    box-shadow:0 2px 5px rgba(0,0,0,.1);
    margin-bottom:10px;
  }
  /* ② 拨号盘缩小 */
  #dialer{
    display:grid;
    grid-template-columns:repeat(3,var(--btn-size));
    grid-gap:8px;
  }
  .dial-button{
    width:var(--btn-size);
    height:var(--btn-size);
    font-size:22px;
    border:none;
    border-radius:50%;
    background:#fff;
    box-shadow:0 2px 5px rgba(0,0,0,.3);
    cursor:pointer;
  }
  /* 共用按钮样式 */
  .action{
    padding:12px 22px;
    font-size:16px;
    margin:12px 6px;
    border:none;
    border-radius:8px;
    cursor:pointer;
    width:110px;
  }
  #callButton{background:#28a745;color:#fff;}
  #hangupButton{background:#dc3545;color:#fff;}
  #answerButton{background:#007bff;color:#fff;position:fixed;right:24px;top:40%;display:none;}
  #rejectButton{background:#6c757d;color:#fff;position:fixed;right:24px;top:52%;display:none;}

  /* ③ 来电信息居中显示 */
  #incomingInfo{
    flex:1;                      /* 占据中间空白 */
    display:flex;
    align-items:center;
    justify-content:center;
    font-size:22px;
    color:#333;
    text-align:center;
    padding:0 15px;
  }
  #callStatus{margin:8px 0;font-size:16px;color:#333;}

</style>
</head>
<body>

  <!-- 顶部区域：输入框 + 拨号盘 -->
  <div id="topArea">
    <div id="numberDisplay">请输入号码</div>
    <div id="dialer">
      <button class="dial-button" onclick="appendNumber('1')">1</button>
      <button class="dial-button" onclick="appendNumber('2')">2</button>
      <button class="dial-button" onclick="appendNumber('3')">3</button>
      <button class="dial-button" onclick="appendNumber('4')">4</button>
      <button class="dial-button" onclick="appendNumber('5')">5</button>
      <button class="dial-button" onclick="appendNumber('6')">6</button>
      <button class="dial-button" onclick="appendNumber('7')">7</button>
      <button class="dial-button" onclick="appendNumber('8')">8</button>
      <button class="dial-button" onclick="appendNumber('9')">9</button>
      <button class="dial-button" onclick="appendNumber('*')">*</button>
      <button class="dial-button" onclick="appendNumber('0')">0</button>
      <button class="dial-button" onclick="appendNumber('#')">#</button>
    </div>
  </div>

  <!-- 中部：来电信息 / 通话状态 -->
  <div id="incomingInfo">
    <div>
      <div id="callStatus">未呼叫</div>
    </div>
  </div>

  <!-- 底部常规按钮 -->
  <button id="callButton" class="action" onclick="makeCall()">📞 呼叫</button>
  <button id="hangupButton" class="action" onclick="hangupCall()" disabled>🛑 挂断</button>
  <!-- 浮动接听 / 拒绝 -->
  <button id="answerButton" class="action" onclick="answerCall()">✅ 接听</button>
  <button id="rejectButton" class="action" onclick="rejectCall()">❌ 拒接</button>

  <audio id="audioRemote" autoplay></audio>
  <audio id="ringtone" src="ringtone.mp3" preload="auto" loop></audio>

  <!-- JsSIP & adapter -->
  <script src="https://webrtc.github.io/adapter/adapter-latest.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jssip@3.0.10/dist/jssip.min.js"></script>

<script>
/* ---------- 变量 ---------- */
let number='';
const numberDisplay=document.getElementById('numberDisplay');
const callButton  =document.getElementById('callButton');
const hangupButton=document.getElementById('hangupButton');
const answerButton=document.getElementById('answerButton');
const rejectButton=document.getElementById('rejectButton');
const statusDisplay=document.getElementById('callStatus');
const infoBox=document.getElementById('incomingInfo');
const remoteAudio=document.getElementById('audioRemote');
const ringtone   =document.getElementById('ringtone');
let session=null,isCalling=false;

/* ---------- UI 辅助 ---------- */
function appendNumber(n){number+=n;numberDisplay.textContent=number;}
function updateStatus(t){statusDisplay.textContent=t;}
function playRingtone(){ringtone.play().catch(()=>{});}
function stopRingtone(){ringtone.pause();ringtone.currentTime=0;}
function resetUI(){
  isCalling=false;number='';session=null;
  numberDisplay.textContent='请输入号码';
  callButton.disabled=false;hangupButton.disabled=true;
  answerButton.style.display=rejectButton.style.display='none';
  infoBox.innerHTML=`<div><div id="callStatus">未呼叫</div></div>`;
}

/* ---------- JsSIP ---------- */
const socket=new JsSIP.WebSocketInterface('wss://xin.anjre.cn:8089/ws');
const ua=new JsSIP.UA({
  sockets:[socket],
  uri:'sip:9930@xin.anjre.cn',
  password:'Aa6363463@',
  display_name:'网页客户',
  session_timers:false,
  register:true
});
ua.start();

/* 来电处理 */
ua.on('newRTCSession',data=>{
  const newSession=data.session;
  if(newSession.direction==='incoming'){
    session=newSession;
    const caller=newSession.remote_identity.uri.user||'未知';
    const cid=newSession.remote_identity.display_name||'';
    infoBox.textContent=`来电：${caller}  ${cid?'（CID: '+cid+'）':''}`;
    updateStatus('来电中 …');
    playRingtone();
    answerButton.style.display='block';
    rejectButton.style.display='block';

    bindStreamEvents(newSession);
    bindEndEvents(newSession);
  }
});

function bindStreamEvents(s){
  s.connection.addEventListener('track',e=>{
    if(e.track.kind==='audio'){
      const ms=new MediaStream();
      ms.addTrack(e.track);
      remoteAudio.srcObject=ms;
      remoteAudio.play().catch(()=>{});
    }
  });
}
function bindEndEvents(s){
  s.on('ended',   ()=>{updateStatus('通话结束');resetUI();});
  s.on('failed',  ()=>{updateStatus('呼叫失败');resetUI();});
  s.on('accepted',()=>{updateStatus('通话中');stopRingtone();});
}

/* 外呼 */
function makeCall(){
  if(isCalling||!number) return;
  isCalling=true;callButton.disabled=true;hangupButton.disabled=false;
  infoBox.textContent='外呼 → '+number;
  updateStatus('正在呼叫…');

  session=ua.call(`sip:${number}@xin.anjre.cn`,{
    mediaConstraints:{audio:true,video:false},
    rtcOfferConstraints:{offerToReceiveAudio:1,offerToReceiveVideo:0}
  });
  bindStreamEvents(session);bindEndEvents(session);
  session.on('progress',()=>updateStatus('振铃中…'));
}

/* 接听 / 拒绝 / 挂断 */
function answerCall(){
  if(!session)return;
  stopRingtone();
  session.answer({mediaConstraints:{audio:true,video:false}});
  answerButton.style.display=rejectButton.style.display='none';
  hangupButton.disabled=false;
}
function rejectCall(){session&&session.terminate();}
function hangupCall(){session&&session.terminate();}

/* 绑定到全局 */
window.appendNumber=appendNumber;
window.makeCall   =makeCall;
window.answerCall =answerCall;
window.rejectCall =rejectCall;
window.hangupCall =hangupCall;
</script>
</body>
</html>
