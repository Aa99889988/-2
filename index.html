<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<title>ç½‘é¡µæ‹¨å·ç›˜</title>
<style>
  :root{ --btn:60px; }

  body{
    font-family:Arial,Helvetica,sans-serif;
    background:#f0f0f0;
    margin:0;
    display:flex;
    flex-direction:column;
    align-items:center;
  }

  /* é¡¶éƒ¨è¾“å…¥æ¡† + æ‹¨å·ç›˜ */
  #topArea{ margin-top:12px; text-align:center; }
  #numberDisplay{
    font-size:22px; width:220px;
    padding:8px; margin-bottom:10px;
    background:#fff; border-radius:8px;
    box-shadow:0 2px 5px rgba(0,0,0,.1);
  }
  #dialer{
    display:grid; grid-template-columns:repeat(3,var(--btn));
    grid-gap:6px;
  }
  .dial-button{
    width:var(--btn); height:var(--btn);
    border:none; border-radius:50%;
    background:#fff; font-size:20px;
    box-shadow:0 2px 5px rgba(0,0,0,.25);
    cursor:pointer;
  }

  /* åº•éƒ¨å¸¸ç”¨æŒ‰é’® */
  .action{
    padding:10px 22px; width:110px;
    font-size:15px; border:none; border-radius:8px;
    cursor:pointer; margin:14px 5px;
  }
  #callButton{background:#28a745;color:#fff;}
  #hangupButton{background:#dc3545;color:#fff;}

  /* æ¥ç”µæŒ‰é’®å›ºå®šå³ä¾§ */
  #answerButton,#rejectButton{
    position:fixed; right:20px; width:120px;
    padding:12px 0; font-size:15px; display:none;
    border:none; border-radius:8px; cursor:pointer;
  }
  #answerButton{top:40%; background:#007bff;color:#fff;}
  #rejectButton{top:54%; background:#6c757d;color:#fff;}

  /* ä¸­å¤®æ¥ç”µ / çŠ¶æ€æ–‡å­— */
  #centerInfo{
    flex:1; display:flex; align-items:center; justify-content:center;
    text-align:center; font-size:18px; color:#333; padding:0 15px;
  }
  #callStatus{margin-top:8px;font-size:16px;color:#333;}
</style>
</head>
<body>

  <!-- é¡¶éƒ¨åŒºåŸŸ -->
  <div id="topArea">
    <div id="numberDisplay">è¯·è¾“å…¥å·ç </div>
    <div id="dialer">
      <button class="dial-button" onclick="appendNumber('1')">1</button>
      <button class="dial-button" onclick="appendNumber('2')">2</button>
      <button class="dial-button" onclick="appendNumber('3')">3</button>
      <button class="dial-button" onclick="appendNumber('4')">4</button>
      <button class="dial-button" onclick="appendNumber('5')">5</button>
      <button class="dial-button" onclick="appendNumber('6')">6</button>
      <button class="dial-button" onclick="appendNumber('7')">7</button>
      <button class="dial-button" onclick="appendNumber('8')">8</button>
      <button class="dial-button" onclick="appendNumber('9')">9</button>
      <button class="dial-button" onclick="appendNumber('*')">*</button>
      <button class="dial-button" onclick="appendNumber('0')">0</button>
      <button class="dial-button" onclick="appendNumber('#')">#</button>
    </div>
  </div>

  <!-- ä¸­å¿ƒä¿¡æ¯åŒº -->
  <div id="centerInfo">
    <div>
      <div id="incomingText"></div>
      <div id="callStatus">æœªå‘¼å«</div>
    </div>
  </div>

  <!-- åº•éƒ¨å¸¸ç”¨æŒ‰é’® -->
  <button id="callButton"   class="action" onclick="makeCall()">ğŸ“ å‘¼å«</button>
  <button id="hangupButton" class="action" onclick="hangupCall()" disabled>ğŸ›‘ æŒ‚æ–­</button>

  <!-- å³ä¾§æ¥ç”µæŒ‰é’® -->
  <button id="answerButton" class="action" onclick="answerCall()">âœ… æ¥å¬</button>
  <button id="rejectButton" class="action" onclick="rejectCall()">âŒ æ‹’æ¥</button>

  <!-- åª’ä½“ -->
  <audio id="audioRemote" autoplay></audio>
  <audio id="ringtone" src="ringtone.mp3" preload="auto" loop></audio>

  <!-- JsSIP & adapter -->
  <script src="https://webrtc.github.io/adapter/adapter-latest.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jssip@3.0.10/dist/jssip.min.js"></script>

<script>
/* ---- å˜é‡ ---- */
let number='';
const numberDisplay=document.getElementById('numberDisplay');
const callBtn  =document.getElementById('callButton');
const hangBtn  =document.getElementById('hangupButton');
const ansBtn   =document.getElementById('answerButton');
const rejBtn   =document.getElementById('rejectButton');
const statusTx =document.getElementById('callStatus');
const incomingTx=document.getElementById('incomingText');
const audioRemote=document.getElementById('audioRemote');
const ring=document.getElementById('ringtone');
let session=null,isCalling=false;

/* ---- UI è¾…åŠ© ---- */
function appendNumber(n){ number+=n; numberDisplay.textContent=number; }
function updateStatus(t){ statusTx.textContent=t; }
function playRing(){ ring.play().catch(()=>{}); }
function stopRing(){ ring.pause(); ring.currentTime=0; }
function resetUI(){
  isCalling=false; number=''; session=null;
  numberDisplay.textContent='è¯·è¾“å…¥å·ç ';
  updateStatus('æœªå‘¼å«'); incomingTx.textContent='';
  callBtn.disabled=false; hangBtn.disabled=true;
  ansBtn.style.display = rejBtn.style.display = 'none';
}

/* ---- JsSIP åˆå§‹åŒ– ---- */
const socket=new JsSIP.WebSocketInterface('wss://xin.anjre.cn:8089/ws');
const ua=new JsSIP.UA({
  sockets:[socket],
  uri:'sip:9930@xin.anjre.cn',
  password:'Aa6363463@00',
  display_name:'ç½‘é¡µå®¢æˆ·',
  session_timers:false,
  register:true
});
ua.start();

/* ---- æ¥ç”µ ---- */
ua.on('newRTCSession', data=>{
  const s=data.session;
  if(s.direction!=='incoming') return;
  session=s;

  const caller=s.remote_identity.uri.user || 'æœªçŸ¥';
  const cid   =s.remote_identity.display_name || 'æœªçŸ¥';
  incomingTx.textContent=`æ¥ç”µå·ç ï¼š${caller}\nOutbound CIDï¼š${cid}`;
  updateStatus('æ¥ç”µä¸­â€¦');
  playRing();

  ansBtn.style.display=rejBtn.style.display='block';
  bindStream(s); bindLifecycle(s);
});

/* ---- å¤–å‘¼ ---- */
function makeCall(){
  if(isCalling||!number) return;
  isCalling=true; callBtn.disabled=true; hangBtn.disabled=false;

  incomingTx.textContent='å¤–å‘¼ â†’ '+number;
  updateStatus('æ­£åœ¨å‘¼å«â€¦');

  session=ua.call(`sip:${number}@xin.anjre.cn`,{
    mediaConstraints:{audio:true,video:false},
    rtcOfferConstraints:{offerToReceiveAudio:1,offerToReceiveVideo:0}
  });
  bindStream(session); bindLifecycle(session);

  session.on('progress',()=>updateStatus('æŒ¯é“ƒä¸­â€¦'));
}

/* ---- åª’ä½“æµ ---- */
function bindStream(s){
  s.connection.addEventListener('track', e=>{
    if(e.track.kind==='audio'){
      const ms=new MediaStream(); ms.addTrack(e.track);
      audioRemote.srcObject=ms; audioRemote.play().catch(()=>{});
    }
  });
}

/* ---- ç”Ÿå‘½å‘¨æœŸ ---- */
function bindLifecycle(s){
  s.on('accepted',()=>{ updateStatus('é€šè¯ä¸­'); stopRing(); });
  s.on('ended',  ()=>{ updateStatus('é€šè¯ç»“æŸ'); resetUI(); });
  s.on('failed', ()=>{ updateStatus('å‘¼å«å¤±è´¥'); resetUI(); });
}

/* ---- æ“ä½œæŒ‰é’® ---- */
function answerCall(){
  if(!session) return;
  stopRing();
  session.answer({mediaConstraints:{audio:true,video:false}});
  ansBtn.style.display=rejBtn.style.display='none';
  hangBtn.disabled=false;
}
function rejectCall(){ session?.terminate(); }
function hangupCall(){ session?.terminate(); }

/* ---- å…¨å±€æš´éœ² ---- */
window.appendNumber=appendNumber;
window.makeCall=makeCall;
window.answerCall=answerCall;
window.rejectCall=rejectCall;
window.hangupCall=hangupCall;
</script>
</body>
</html>
