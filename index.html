<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>ç½‘é¡µæ‹¨å·ç›˜</title>
<style>
  :root{
    --btn-size:60px;             /* æ‹¨å·é”®å°ºå¯¸ */
  }
  body{
    font-family:Arial, sans-serif;
    background:#f0f0f0;
    margin:0;
    display:flex;
    flex-direction:column;
    align-items:center;
  }
  /* â‘  é¡¶ç«¯è¾“å…¥æ¡† */
  #topArea{
    width:100%;
    max-width:320px;
    display:flex;
    flex-direction:column;
    align-items:center;
    margin-top:12px;
  }
  #numberDisplay{
    font-size:24px;
    width:100%;
    text-align:center;
    padding:10px;
    background:#fff;
    border-radius:8px;
    box-shadow:0 2px 5px rgba(0,0,0,.1);
    margin-bottom:10px;
  }
  /* â‘¡ æ‹¨å·ç›˜ç¼©å° */
  #dialer{
    display:grid;
    grid-template-columns:repeat(3,var(--btn-size));
    grid-gap:8px;
  }
  .dial-button{
    width:var(--btn-size);
    height:var(--btn-size);
    font-size:22px;
    border:none;
    border-radius:50%;
    background:#fff;
    box-shadow:0 2px 5px rgba(0,0,0,.3);
    cursor:pointer;
  }
  /* å…±ç”¨æŒ‰é’®æ ·å¼ */
  .action{
    padding:12px 22px;
    font-size:16px;
    margin:12px 6px;
    border:none;
    border-radius:8px;
    cursor:pointer;
    width:110px;
  }
  #callButton{background:#28a745;color:#fff;}
  #hangupButton{background:#dc3545;color:#fff;}
  #answerButton{background:#007bff;color:#fff;position:fixed;right:24px;top:40%;display:none;}
  #rejectButton{background:#6c757d;color:#fff;position:fixed;right:24px;top:52%;display:none;}

  /* â‘¢ æ¥ç”µä¿¡æ¯å±…ä¸­æ˜¾ç¤º */
  #incomingInfo{
    flex:1;                      /* å æ®ä¸­é—´ç©ºç™½ */
    display:flex;
    align-items:center;
    justify-content:center;
    font-size:22px;
    color:#333;
    text-align:center;
    padding:0 15px;
  }
  #callStatus{margin:8px 0;font-size:16px;color:#333;}

</style>
</head>
<body>

  <!-- é¡¶éƒ¨åŒºåŸŸï¼šè¾“å…¥æ¡† + æ‹¨å·ç›˜ -->
  <div id="topArea">
    <div id="numberDisplay">è¯·è¾“å…¥å·ç </div>
    <div id="dialer">
      <button class="dial-button" onclick="appendNumber('1')">1</button>
      <button class="dial-button" onclick="appendNumber('2')">2</button>
      <button class="dial-button" onclick="appendNumber('3')">3</button>
      <button class="dial-button" onclick="appendNumber('4')">4</button>
      <button class="dial-button" onclick="appendNumber('5')">5</button>
      <button class="dial-button" onclick="appendNumber('6')">6</button>
      <button class="dial-button" onclick="appendNumber('7')">7</button>
      <button class="dial-button" onclick="appendNumber('8')">8</button>
      <button class="dial-button" onclick="appendNumber('9')">9</button>
      <button class="dial-button" onclick="appendNumber('*')">*</button>
      <button class="dial-button" onclick="appendNumber('0')">0</button>
      <button class="dial-button" onclick="appendNumber('#')">#</button>
    </div>
  </div>

  <!-- ä¸­éƒ¨ï¼šæ¥ç”µä¿¡æ¯ / é€šè¯çŠ¶æ€ -->
  <div id="incomingInfo">
    <div>
      <div id="callStatus">æœªå‘¼å«</div>
    </div>
  </div>

  <!-- åº•éƒ¨å¸¸è§„æŒ‰é’® -->
  <button id="callButton" class="action" onclick="makeCall()">ğŸ“ å‘¼å«</button>
  <button id="hangupButton" class="action" onclick="hangupCall()" disabled>ğŸ›‘ æŒ‚æ–­</button>
  <!-- æµ®åŠ¨æ¥å¬ / æ‹’ç» -->
  <button id="answerButton" class="action" onclick="answerCall()">âœ… æ¥å¬</button>
  <button id="rejectButton" class="action" onclick="rejectCall()">âŒ æ‹’æ¥</button>

  <audio id="audioRemote" autoplay></audio>
  <audio id="ringtone" src="ringtone.mp3" preload="auto" loop></audio>

  <!-- JsSIP & adapter -->
  <script src="https://webrtc.github.io/adapter/adapter-latest.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jssip@3.0.10/dist/jssip.min.js"></script>

<script>
/* ---------- å˜é‡ ---------- */
let number='';
const numberDisplay=document.getElementById('numberDisplay');
const callButton  =document.getElementById('callButton');
const hangupButton=document.getElementById('hangupButton');
const answerButton=document.getElementById('answerButton');
const rejectButton=document.getElementById('rejectButton');
const statusDisplay=document.getElementById('callStatus');
const infoBox=document.getElementById('incomingInfo');
const remoteAudio=document.getElementById('audioRemote');
const ringtone   =document.getElementById('ringtone');
let session=null,isCalling=false;

/* ---------- UI è¾…åŠ© ---------- */
function appendNumber(n){number+=n;numberDisplay.textContent=number;}
function updateStatus(t){statusDisplay.textContent=t;}
function playRingtone(){ringtone.play().catch(()=>{});}
function stopRingtone(){ringtone.pause();ringtone.currentTime=0;}
function resetUI(){
  isCalling=false;number='';session=null;
  numberDisplay.textContent='è¯·è¾“å…¥å·ç ';
  callButton.disabled=false;hangupButton.disabled=true;
  answerButton.style.display=rejectButton.style.display='none';
  infoBox.innerHTML=`<div><div id="callStatus">æœªå‘¼å«</div></div>`;
}

/* ---------- JsSIP ---------- */
const socket=new JsSIP.WebSocketInterface('wss://xin.anjre.cn:8089/ws');
const ua=new JsSIP.UA({
  sockets:[socket],
  uri:'sip:9930@xin.anjre.cn',
  password:'Aa6363463@',
  display_name:'ç½‘é¡µå®¢æˆ·',
  session_timers:false,
  register:true
});
ua.start();

/* æ¥ç”µå¤„ç† */
ua.on('newRTCSession',data=>{
  const newSession=data.session;
  if(newSession.direction==='incoming'){
    session=newSession;
    const caller=newSession.remote_identity.uri.user||'æœªçŸ¥';
    const cid=newSession.remote_identity.display_name||'';
    infoBox.textContent=`æ¥ç”µï¼š${caller}  ${cid?'ï¼ˆCID: '+cid+'ï¼‰':''}`;
    updateStatus('æ¥ç”µä¸­ â€¦');
    playRingtone();
    answerButton.style.display='block';
    rejectButton.style.display='block';

    bindStreamEvents(newSession);
    bindEndEvents(newSession);
  }
});

function bindStreamEvents(s){
  s.connection.addEventListener('track',e=>{
    if(e.track.kind==='audio'){
      const ms=new MediaStream();
      ms.addTrack(e.track);
      remoteAudio.srcObject=ms;
      remoteAudio.play().catch(()=>{});
    }
  });
}
function bindEndEvents(s){
  s.on('ended',   ()=>{updateStatus('é€šè¯ç»“æŸ');resetUI();});
  s.on('failed',  ()=>{updateStatus('å‘¼å«å¤±è´¥');resetUI();});
  s.on('accepted',()=>{updateStatus('é€šè¯ä¸­');stopRingtone();});
}

/* å¤–å‘¼ */
function makeCall(){
  if(isCalling||!number) return;
  isCalling=true;callButton.disabled=true;hangupButton.disabled=false;
  infoBox.textContent='å¤–å‘¼ â†’ '+number;
  updateStatus('æ­£åœ¨å‘¼å«â€¦');

  session=ua.call(`sip:${number}@xin.anjre.cn`,{
    mediaConstraints:{audio:true,video:false},
    rtcOfferConstraints:{offerToReceiveAudio:1,offerToReceiveVideo:0}
  });
  bindStreamEvents(session);bindEndEvents(session);
  session.on('progress',()=>updateStatus('æŒ¯é“ƒä¸­â€¦'));
}

/* æ¥å¬ / æ‹’ç» / æŒ‚æ–­ */
function answerCall(){
  if(!session)return;
  stopRingtone();
  session.answer({mediaConstraints:{audio:true,video:false}});
  answerButton.style.display=rejectButton.style.display='none';
  hangupButton.disabled=false;
}
function rejectCall(){session&&session.terminate();}
function hangupCall(){session&&session.terminate();}

/* ç»‘å®šåˆ°å…¨å±€ */
window.appendNumber=appendNumber;
window.makeCall   =makeCall;
window.answerCall =answerCall;
window.rejectCall =rejectCall;
window.hangupCall =hangupCall;
</script>
</body>
</html>
